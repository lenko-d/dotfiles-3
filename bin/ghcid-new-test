#!/bin/bash

# Program:     ghcid-new-test
# Description: Convenient wrapper for running Cabal project test suites on file
#              changes, using the `ghcid` program.
# Author:      Oskar Wickstr√∂m<oskar.wickstrom@gmail.com>

echoerr() {
  echo "$@" 1>&2;
}

usage() {
  cat 1>&2 <<EOM
Usage:

  $(basename "$0") TARGET

Arguments:

  TARGET
    A test suite target, e.g. \`my-tests\`.

EOM
}

TARGET=$1

if [ -z "$TARGET" ]; then
  echoerr "No test target specified!"
  usage
  exit 1
fi

export TASTY_COLOR=always

ghcid \
  -c "cabal new-repl ${TARGET}" \
  --warnings \
  --test ':load Main' \
  --test ':main' \
  --reload test \
  --restart src \
  --restart $(find ./ -maxdepth 1 -name '*.cabal' | head -n1)
